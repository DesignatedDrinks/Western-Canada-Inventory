<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Western Canada Inventory</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      background: #f4f6f8;
      color: #222;
      font-family: 'Segoe UI', Arial, sans-serif;
    }
    body {
      min-height: 100vh;
    }
    h1 {
      margin: 40px 0 18px 0;
      text-align: center;
      font-size: 2.1rem;
      color: #062248;
      letter-spacing: -.5px;
      font-weight: 700;
      line-height: 1.1;
    }
    .search-bar {
      display: flex;
      justify-content: center;
      margin-bottom: 18px;
    }
    .search-bar input {
      font-size: 1.1rem;
      width: 94vw;
      max-width: 460px;
      padding: 13px 16px;
      border: 1.5px solid #cfd8dc;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.03);
      outline: none;
      margin: 0 auto;
      display: block;
    }
    .product-list {
      margin: 0 auto;
      width: 97vw;
      max-width: 480px;
    }
    .product-card {
      background: #fff;
      border-radius: 16px;
      margin-bottom: 15px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.04);
      padding: 18px 18px 12px 18px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: box-shadow 0.13s;
      border: none;
    }
    .product-card:active, .product-card:hover {
      box-shadow: 0 4px 18px rgba(14,40,90,0.07);
    }
    .product-title {
      width: 100%;
      font-size: 1.1rem;
      font-weight: 600;
      text-align: center;
      margin-bottom: 5px;
      color: #0e2d5d;
      word-break: break-word;
    }
    .product-qty {
      width: 100%;
      text-align: center;
      font-size: 1.2rem;
      font-weight: 700;
      color: #1a2c49;
      letter-spacing: 1px;
    }
    /* MODAL */
    .modal-backdrop {
      position: fixed;
      z-index: 10;
      left: 0; top: 0; right: 0; bottom: 0;
      background: rgba(32,38,53,0.30);
      display: flex;
      justify-content: center;
      align-items: center;
      transition: background .1s;
    }
    .modal {
      background: #fff;
      border-radius: 24px;
      box-shadow: 0 10px 32px rgba(0,0,0,0.09);
      max-width: 360px;
      width: 92vw;
      padding: 26px 20px 20px 20px;
      text-align: center;
      position: relative;
      animation: popup 0.21s;
    }
    @keyframes popup {
      from { transform: scale(0.91); opacity: 0.6; }
      to { transform: scale(1); opacity: 1; }
    }
    .modal-close {
      position: absolute;
      right: 20px;
      top: 17px;
      font-size: 1.6rem;
      color: #244a78;
      background: none;
      border: none;
      cursor: pointer;
      padding: 0;
      z-index: 12;
    }
    .modal-image {
      width: 90px;
      height: 90px;
      object-fit: contain;
      margin-bottom: 15px;
      margin-top: 5px;
    }
    .modal-title {
      font-size: 1.08rem;
      font-weight: 700;
      margin-bottom: 19px;
      color: #0e2d5d;
      text-align: center;
      word-break: break-word;
    }
    .modal-qty-controls {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 13px;
      margin-bottom: 18px;
    }
    .modal-qty-btn {
      font-size: 1.5rem;
      background: #f3f6fb;
      color: #0e2d5d;
      border: none;
      border-radius: 10px;
      width: 46px;
      height: 46px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      cursor: pointer;
      transition: background 0.1s;
    }
    .modal-qty-btn:active { background: #dde9fb; }
    .modal-qty-input {
      font-size: 1.5rem;
      width: 70px;
      text-align: center;
      border: 2px solid #dae3ee;
      border-radius: 9px;
      padding: 7px 0;
      margin: 0 3px;
    }
    .modal-save-btn {
      margin-top: 0px;
      width: 100%;
      padding: 14px 0;
      background: #062248;
      color: #fff;
      border: none;
      border-radius: 13px;
      font-size: 1.2rem;
      font-weight: 700;
      cursor: pointer;
      letter-spacing: .5px;
      transition: background 0.12s;
    }
    .modal-save-btn:active { background: #1c3d65; }
    .spinner {
      border: 4px solid #e6e9ef;
      border-top: 4px solid #0e2d5d;
      border-radius: 50%;
      width: 38px;
      height: 38px;
      animation: spin 0.6s linear infinite;
      margin: 16px auto 6px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg);}
      100% { transform: rotate(360deg);}
    }
    @media (max-width: 550px) {
      h1 { font-size: 1.22rem; }
      .search-bar input { font-size: 1rem; }
      .modal { max-width: 99vw; }
    }
    /* Hide scroll bar on mobile, just a little cleaner */
    ::-webkit-scrollbar { display: none; }
    body { -ms-overflow-style: none; scrollbar-width: none; }
  </style>
</head>
<body>
  <h1>Western Canada<br>Inventory</h1>
  <div class="search-bar">
    <input id="searchInput" type="text" placeholder="Search product name..." autocomplete="off">
  </div>
  <div class="product-list" id="productList"></div>

  <!-- Modal is injected by JS -->

  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbyE5WZG0nUnrDLL0HfROliIdvWVRynC3nt-bWt6eTlvZP-InbhxsxBCtZWyM9BsM7Gz-Q/exec';
    let inventory = [];
    let searchTimeout = null;

    async function fetchInventory() {
      const res = await fetch(API_URL);
      return await res.json();
    }

    function renderProductList(list) {
      const productList = document.getElementById('productList');
      productList.innerHTML = '';
      for (const product of list) {
        const card = document.createElement('div');
        card.className = 'product-card';
        card.onclick = () => openModal(product);
        // Card content
        const title = document.createElement('div');
        title.className = 'product-title';
        title.textContent = product['Product Title'];
        const qty = document.createElement('div');
        qty.className = 'product-qty';
        qty.textContent = product['Quantity'] || 0;
        card.appendChild(title);
        card.appendChild(qty);
        productList.appendChild(card);
      }
    }

    function openModal(product) {
      closeModal(); // remove any open modal
      const modalBackdrop = document.createElement('div');
      modalBackdrop.className = 'modal-backdrop';
      modalBackdrop.onclick = (e) => { if (e.target === modalBackdrop) closeModal(); };
      // Modal content
      const modal = document.createElement('div');
      modal.className = 'modal';
      // Close button
      const closeBtn = document.createElement('button');
      closeBtn.className = 'modal-close';
      closeBtn.innerHTML = '&times;';
      closeBtn.onclick = closeModal;
      modal.appendChild(closeBtn);

      // Image
      const img = document.createElement('img');
      img.src = product['Image URL'];
      img.className = 'modal-image';
      modal.appendChild(img);

      // Product Title
      const t = document.createElement('div');
      t.className = 'modal-title';
      t.textContent = product['Product Title'];
      modal.appendChild(t);

      // Qty controls
      const qtyControls = document.createElement('div');
      qtyControls.className = 'modal-qty-controls';

      const minusBtn = document.createElement('button');
      minusBtn.className = 'modal-qty-btn';
      minusBtn.textContent = 'â€“';
      const plusBtn = document.createElement('button');
      plusBtn.className = 'modal-qty-btn';
      plusBtn.textContent = '+';

      const qtyInput = document.createElement('input');
      qtyInput.type = 'number';
      qtyInput.min = 0;
      qtyInput.className = 'modal-qty-input';
      qtyInput.value = product['Quantity'] || 0;

      minusBtn.onclick = () => { qtyInput.value = Math.max(0, Number(qtyInput.value) - 1); };
      plusBtn.onclick = () => { qtyInput.value = Number(qtyInput.value) + 1; };

      qtyControls.appendChild(minusBtn);
      qtyControls.appendChild(qtyInput);
      qtyControls.appendChild(plusBtn);
      modal.appendChild(qtyControls);

      // Save button
      const saveBtn = document.createElement('button');
      saveBtn.className = 'modal-save-btn';
      saveBtn.textContent = 'Save';

      saveBtn.onclick = async () => {
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<div class="spinner"></div>';
        try {
          await updateQty(product, Number(qtyInput.value));
          closeModal();
          inventory = await fetchInventory();
          renderProductList(filterList(document.getElementById('searchInput').value));
        } catch {
          saveBtn.textContent = 'Try Again';
          saveBtn.disabled = false;
        }
      };

      modal.appendChild(saveBtn);
      modalBackdrop.appendChild(modal);
      document.body.appendChild(modalBackdrop);
    }

    function closeModal() {
      const existing = document.querySelector('.modal-backdrop');
      if (existing) existing.remove();
    }

    async function updateQty(product, newQty) {
      const payload = {
        productTitle: product['Product Title'],
        newQty: newQty,
        action: 'Manual Update'
      };
      const res = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const text = await res.text();
      if (!text.startsWith('Success')) throw new Error('Update failed');
    }

    function filterList(query) {
      query = (query || '').trim().toLowerCase();
      if (!query) return inventory;
      return inventory.filter(item => item['Product Title'].toLowerCase().includes(query));
    }

    // Debounce search for smoother UX
    document.getElementById('searchInput').addEventListener('input', function () {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        renderProductList(filterList(this.value));
      }, 180);
    });

    // Initial load
    (async () => {
      inventory = await fetchInventory();
      renderProductList(inventory);
    })();
  </script>
</body>
</html>
